#!/usr/bin/env python3
"""
–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–æ–ª–∂–Ω–æ—Å—Ç—è–º, –≤–æ–∑—Ä–∞—Å—Ç—É –∏ –±–∞–∑–æ–≤–æ–º—É –∞—ç—Ä–æ–ø–æ—Ä—Ç—É –∏–∑ –°–ê–ü.
–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.

–¢—Ä–µ–±—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
- DB_HOST - —Ö–æ—Å—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL
- DB_PORT - –ø–æ—Ä—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL
- DB_NAME - –∏–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL
- DB_USER - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL
- DB_PASSWORD - –ø–∞—Ä–æ–ª—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL
- TEST_DB_* - –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
- ADP_SAP_* - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î adp-sap (–¥–∞–Ω–Ω—ã–µ –°–ê–ü)
- ACCORD_HOST - —Ö–æ—Å—Ç –±–∞–∑—ã –ê–∫–∫–æ—Ä–¥ (Firebird)
- ACCORD_PORT - –ø–æ—Ä—Ç –±–∞–∑—ã –ê–∫–∫–æ—Ä–¥ (Firebird)
- ACCORD_DB - –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –ë–î –ê–∫–∫–æ—Ä–¥
- ACCORD_USER - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ê–∫–∫–æ—Ä–¥
- ACCORD_PASSWORD - –ø–∞—Ä–æ–ª—å –ê–∫–∫–æ—Ä–¥
"""

import os
import psycopg2
from psycopg2.extras import RealDictCursor
from datetime import datetime, timedelta
import argparse
import sys
import json
import copy

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞
try:
    from dotenv import load_dotenv
    load_dotenv()
    print("‚úì –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ .env —Ñ–∞–π–ª–∞")
except ImportError:
    print("‚ö† python-dotenv –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.")
    print("  –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install python-dotenv")

try:
    import fdb
    FIREBIRD_AVAILABLE = True
except ImportError:
    FIREBIRD_AVAILABLE = False
    print("‚ö† –í–Ω–∏–º–∞–Ω–∏–µ: fdb –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ê–∫–∫–æ—Ä–¥ –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.")
    print("  –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install fdb")


def get_env_or_default(key, default):
    """–ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é."""
    return os.environ.get(key, default)


def get_db_connection(db_type='personnel'):
    """
    –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
    
    Args:
        db_type: 'personnel' - –æ—Å–Ω–æ–≤–Ω–∞—è –ë–î ms-personnel (PostgreSQL)
                'test' - —Ç–µ—Å—Ç–æ–≤–∞—è –ë–î ms-personnel (PostgreSQL)
                'adp-sap' - –ë–î adp-sap —Å –¥–∞–Ω–Ω—ã–º–∏ –°–ê–ü (PostgreSQL)
                'accord' - –ë–î –ê–∫–∫–æ—Ä–¥ (Firebird)
    
    Returns:
        –û–±—ä–µ–∫—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è psycopg2 –∏–ª–∏ fdb
    """
    if db_type == 'personnel':
        conn = psycopg2.connect(
            host=get_env_or_default('DB_HOST', '192.168.199.217'),
            port=get_env_or_default('DB_PORT', '5432'),
            database=get_env_or_default('DB_NAME', 'ms-personnel'),
            user=get_env_or_default('DB_USER', 'postgres'),
            password=get_env_or_default('DB_PASSWORD', 'password')
        )
    elif db_type == 'test':
        conn = psycopg2.connect(
            host=get_env_or_default('TEST_DB_HOST', '192.168.1.62'),
            port=get_env_or_default('TEST_DB_PORT', '5432'),
            database=get_env_or_default('TEST_DB_NAME', 'ms-personnel-test'),
            user=get_env_or_default('TEST_DB_USER', 'postgres'),
            password=get_env_or_default('TEST_DB_PASSWORD', 'password')
        )
    elif db_type == 'accord':
        if not FIREBIRD_AVAILABLE:
            raise ImportError("–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ê–∫–∫–æ—Ä–¥ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å fdb: pip install fdb")
        
        # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebird (—Ñ–æ—Ä–º–∞—Ç: jdbc:firebirdsql://host:port/dbname)
        conn = fdb.connect(
            host=get_env_or_default('ACCORD_HOST', '192.168.1.62'),
            port=int(get_env_or_default('ACCORD_PORT', '3050')),
            database=get_env_or_default('ACCORD_DB', 'akkord'),
            user=get_env_or_default('ACCORD_USER', 'SYSDBA'),
            password=get_env_or_default('ACCORD_PASSWORD', 'masterkey')
        )
    elif db_type == 'adp-sap':
        # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î adp-sap —Å –¥–∞–Ω–Ω—ã–º–∏ –°–ê–ü
        conn = psycopg2.connect(
            host=get_env_or_default('ADP_SAP_HOST', '192.168.1.62'),
            port=get_env_or_default('ADP_SAP_PORT', '5432'),
            database=get_env_or_default('ADP_SAP_DB', 'adp-sap'),
            user=get_env_or_default('ADP_SAP_USER', 'postgres'),
            password=get_env_or_default('ADP_SAP_PASSWORD', 'password')
        )
    else:
        raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ë–î: {db_type}")
    
    return conn


def get_employee_data_snapshot(cursor, employee_numbers):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–Ω–∏–º–æ–∫ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º.
    
    Args:
        cursor: –∫—É—Ä—Å–æ—Ä –ë–î
        employee_numbers: —Å–ø–∏—Å–æ–∫ —Ç–∞–±–µ–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
    """
    if not employee_numbers:
        return {}
    
    query = """
    SELECT 
        e.employee_number,
        e.surname || ' ' || e.name || ' ' || COALESCE(e.patronymic, '') AS fio,
        e.birth_date,
        e.citizenship,
        tds.title_id AS tds_title_id,
        tds.title AS tds_title,
        fi.position AS fi_position,
        fi.base_airport,
        pol.obj_id1 AS pol_title_id,
        pol.expired AS pol_expired
    FROM UNNEST(ARRAY[%s]) ids(ids)
    LEFT JOIN personnel_v2.employee e ON e.employee_number = ids.ids
    LEFT JOIN personnel_v2.flight_info fi ON fi.employee_number = ids.ids AND fi.expired = FALSE
    LEFT JOIN personnel_v2.title_dep_summary tds ON tds.employee_number = ids.ids
    LEFT JOIN personnel_v2.personnel_object_link pol ON pol.type = 'A008' 
        AND pol.expired = FALSE 
        AND pol.obj_id2 = LPAD(ids.ids::text, 8, '0')
    """ % ','.join(str(int(e)) for e in employee_numbers)
    
    cursor.execute(query)
    rows = cursor.fetchall()
    
    snapshot = {}
    for row in rows:
        en = row[0]
        snapshot[en] = {
            'fio': row[1],
            'birth_date': str(row[2]) if row[2] else None,
            'citizenship': row[3],
            'tds_title_id': row[4],
            'tds_title': row[5],
            'fi_position': row[6],
            'base_airport': row[7],
            'pol_title_id': row[8],
            'pol_expired': row[9]
        }
    
    return snapshot


def execute_sql_script(conn, sql_script):
    """
    –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL-—Å–∫—Ä–∏–ø—Ç –Ω–∞ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
    
    Args:
        conn: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
        sql_script: —Ç–µ–∫—Å—Ç SQL-—Å–∫—Ä–∏–ø—Ç–∞
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    """
    results = {
        'success': True,
        'executed_statements': 0,
        'errors': [],
        'affected_rows': 0
    }
    
    cursor = conn.cursor()
    
    try:
        # –†–∞–∑–±–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ statements
        statements = [s.strip() for s in sql_script.split(';') if s.strip() and not s.strip().startswith('--')]
        
        for stmt in statements:
            if stmt and not stmt.startswith('--'):
                try:
                    cursor.execute(stmt)
                    results['executed_statements'] += 1
                    results['affected_rows'] += cursor.rowcount
                except Exception as e:
                    results['errors'].append(f"–û—à–∏–±–∫–∞ –≤ stmt: {stmt[:50]}... - {e}")
        
        conn.commit()
        
    except Exception as e:
        results['success'] = False
        results['errors'].append(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        conn.rollback()
    
    cursor.close()
    
    return results


def compare_snapshots(before_snapshot, after_snapshot):
    """
    –°—Ä–∞–≤–Ω–∏—Ç—å —Å–Ω–∏–º–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ –∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
    
    Args:
        before_snapshot: —Å–Ω–∏–º–æ–∫ –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        after_snapshot: —Å–Ω–∏–º–æ–∫ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    """
    comparison = {
        'total_checked': len(before_snapshot),
        'changed': 0,
        'unchanged': 0,
        'not_found': 0,
        'changes': [],
        'issues': []
    }
    
    for en, before_data in before_snapshot.items():
        after_data = after_snapshot.get(en)
        
        if not after_data:
            comparison['not_found'] += 1
            comparison['issues'].append(f"–°–æ—Ç—Ä—É–¥–Ω–∏–∫ {en} –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
            continue
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        changes = {}
        for key in before_data:
            if before_data[key] != after_data.get(key):
                changes[key] = {
                    'before': before_data[key],
                    'after': after_data.get(key)
                }
        
        if changes:
            comparison['changed'] += 1
            comparison['changes'].append({
                'employee_number': en,
                'fio': before_data['fio'],
                'changes': changes
            })
        else:
            comparison['unchanged'] += 1
    
    return comparison


def generate_test_report(before_snapshot, after_snapshot, comparison, execution_results):
    """
    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏.
    
    Args:
        before_snapshot: —Å–Ω–∏–º–æ–∫ –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        after_snapshot: —Å–Ω–∏–º–æ–∫ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        comparison: —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        execution_results: —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞
    
    Returns:
        –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç
    """
    report_lines = []
    report_lines.append("=" * 70)
    report_lines.append("–û–¢–ß–Å–¢ –û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ò –ù–ê –¢–ï–°–¢–û–í–û–ô –ë–ê–ó–ï")
    report_lines.append(f"–î–∞—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    report_lines.append("=" * 70)
    
    # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞
    report_lines.append("\nüìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –í–´–ü–û–õ–ù–ï–ù–ò–Ø –°–ö–†–ò–ü–¢–ê:")
    report_lines.append("-" * 70)
    report_lines.append(f"  –°—Ç–∞—Ç—É—Å: {'‚úì –£–°–ü–ï–•' if execution_results['success'] else '‚úó –û–®–ò–ë–ö–ê'}")
    report_lines.append(f"  –í—ã–ø–æ–ª–Ω–µ–Ω–æ statements: {execution_results['executed_statements']}")
    report_lines.append(f"  –ó–∞—Ç—Ä–æ–Ω—É—Ç–æ —Å—Ç—Ä–æ–∫: {execution_results['affected_rows']}")
    
    if execution_results['errors']:
        report_lines.append(f"  –û—à–∏–±–æ–∫: {len(execution_results['errors'])}")
        for err in execution_results['errors'][:5]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5 –æ—à–∏–±–æ–∫
            report_lines.append(f"    - {err[:100]}...")
    
    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    report_lines.append("\nüìã –°–†–ê–í–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• (–î–û / –ü–û–°–õ–ï):")
    report_lines.append("-" * 70)
    report_lines.append(f"  –í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: {comparison['total_checked']}")
    report_lines.append(f"  –ò–∑–º–µ–Ω–µ–Ω–æ: {comparison['changed']}")
    report_lines.append(f"  –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π: {comparison['unchanged']}")
    report_lines.append(f"  –ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {comparison['not_found']}")
    
    # –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
    if comparison['changes']:
        report_lines.append("\nüìù –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô (–ø–µ—Ä–≤—ã–µ 10):")
        report_lines.append("-" * 70)
        
        for change in comparison['changes'][:10]:
            en = change['employee_number']
            fio = change['fio']
            changes = change['changes']
            
            report_lines.append(f"  [{en}] {fio}")
            for field, diff in changes.items():
                report_lines.append(f"    {field}: {diff['before']} -> {diff['after']}")
            
            if len(comparison['changes']) > 10:
                report_lines.append(f"  ... –∏ –µ—â—ë {len(comparison['changes']) - 10} –∏–∑–º–µ–Ω–µ–Ω–∏–π")
                break
    
    # –ü—Ä–æ–±–ª–µ–º—ã
    if comparison['issues']:
        report_lines.append("\n‚ö† –í–´–Ø–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:")
        report_lines.append("-" * 70)
        for issue in comparison['issues'][:10]:
            report_lines.append(f"  - {issue}")
    
    # –ò—Ç–æ–≥–∏
    report_lines.append("\n" + "=" * 70)
    report_lines.append("–ò–¢–û–ì–ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:")
    report_lines.append("-" * 70)
    
    if execution_results['success'] and comparison['changed'] > 0 and not comparison['issues']:
        report_lines.append("  ‚úì –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–û–ô–î–ï–ù–û –£–°–ü–ï–®–ù–û")
        report_lines.append("  ‚úì –°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –±–µ–∑ –æ—à–∏–±–æ–∫")
        report_lines.append("  ‚úì –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
    elif not execution_results['success']:
        report_lines.append("  ‚úó –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ù–ï –ü–†–û–ô–î–ï–ù–û")
        report_lines.append("  ‚úó –û—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞")
    elif comparison['not_found'] > 0:
        report_lines.append("  ‚ö† –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –° –ó–ê–ú–ï–ß–ê–ù–ò–Ø–ú–ò")
        report_lines.append("  ‚ö† –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
    else:
        report_lines.append("  ‚ö† –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –° –ó–ê–ú–ï–ß–ê–ù–ò–Ø–ú–ò")
        report_lines.append("  ‚ö† –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã")
    
    report_lines.append("=" * 70)
    
    return '\n'.join(report_lines)


def run_test_cycle(employee_numbers, sql_script, test_conn):
    """
    –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑–µ.
    
    Args:
        employee_numbers: —Å–ø–∏—Å–æ–∫ —Ç–∞–±–µ–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
        sql_script: —Ç–µ–∫—Å—Ç SQL-—Å–∫—Ä–∏–ø—Ç–∞
        test_conn: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    """
    print("\n" + "=" * 60)
    print("–ó–ê–ü–£–°–ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –ù–ê –¢–ï–°–¢–û–í–û–ô –ë–ê–ó–ï")
    print("=" * 60)
    
    test_cursor = test_conn.cursor()
    
    # 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–Ω–∏–º–æ–∫ –¥–∞–Ω–Ω—ã—Ö –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    print("\n[1/4] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–Ω–∏–º–∫–∞ –¥–∞–Ω–Ω—ã—Ö –î–û –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...")
    before_snapshot = get_employee_data_snapshot(test_cursor, employee_numbers)
    print(f"‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ {len(before_snapshot)} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö")
    
    # 2. –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç
    print("\n[2/4] –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL-—Å–∫—Ä–∏–ø—Ç–∞...")
    execution_results = execute_sql_script(test_conn, sql_script)
    
    if execution_results['success']:
        print(f"‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ {execution_results['executed_statements']} statements")
        print(f"‚úì –ó–∞—Ç—Ä–æ–Ω—É—Ç–æ {execution_results['affected_rows']} —Å—Ç—Ä–æ–∫")
    else:
        print(f"‚úó –û—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏: {len(execution_results['errors'])}")
        for err in execution_results['errors'][:3]:
            print(f"  - {err[:80]}...")
    
    # 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–Ω–∏–º–æ–∫ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    print("\n[3/4] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–Ω–∏–º–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ü–û–°–õ–ï –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...")
    after_snapshot = get_employee_data_snapshot(test_cursor, employee_numbers)
    print(f"‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ {len(after_snapshot)} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö")
    
    test_cursor.close()
    
    # 4. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    print("\n[4/4] –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...")
    comparison = compare_snapshots(before_snapshot, after_snapshot)
    print(f"‚úì –ò–∑–º–µ–Ω–µ–Ω–æ: {comparison['changed']}")
    print(f"‚úì –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π: {comparison['unchanged']}")
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á—ë—Ç
    report = generate_test_report(before_snapshot, after_snapshot, comparison, execution_results)
    
    return {
        'before_snapshot': before_snapshot,
        'after_snapshot': after_snapshot,
        'comparison': comparison,
        'execution_results': execution_results,
        'report': report
    }


def collect_employee_numbers_for_update(conn):
    """
    –°–æ–±—Ä–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–∞–±–µ–ª—å–Ω–∏–∫–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
    
    Returns:
        –°–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–∞–±–µ–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
    """
    cursor = conn.cursor()
    
    accord_employees = []
    
    # 1. –ó–∞–ø—Ä–æ—Å –∫ –ê–∫–∫–æ—Ä–¥—É - —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 –¥–Ω–µ–π
    if FIREBIRD_AVAILABLE:
        try:
            accord_conn = get_db_connection('accord')
            accord_cursor = accord_conn.cursor()
            
            # Firebird —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
            accord_query = """
            SELECT DISTINCT pm.SAP_TAB
            FROM PERS_MAIN_HIST pmh 
            JOIN PERS_MAIN pm ON pmh.ID_PERS = pm.ID_PERS 
            JOIN PERS_MAIN_HIST pmh2 ON pmh2.ID_PERS = pmh.ID_PERS
            WHERE pmh.DAT_E IS NULL
            AND (pmh.DAT_E > CAST((CURRENT_TIMESTAMP - 50) AS DATE) 
                 OR pmh.DAT_B > CAST((CURRENT_TIMESTAMP - 50) AS DATE))
            AND pm.SAP_TAB < 300000
            ORDER BY pm.SAP_TAB
            """
            
            accord_cursor.execute(accord_query)
            accord_employees = [row[0] for row in accord_cursor.fetchall()]
            accord_cursor.close()
            accord_conn.close()
            
            print(f"‚úì –ü–æ–ª—É—á–µ–Ω–æ {len(accord_employees)} —Ç–∞–±–µ–ª—å–Ω–∏–∫–æ–≤ –∏–∑ –ê–∫–∫–æ—Ä–¥–∞")
            
        except Exception as e:
            print(f"‚ö† –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ê–∫–∫–æ—Ä–¥–∞: {e}")
            accord_employees = []
    else:
        print("‚ö† –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ê–∫–∫–æ—Ä–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ (fdb –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)")
    
    # 2. –ó–∞–ø—Ä–æ—Å –∫ –ø–µ—Ä—Å–æ–Ω–∞–ª—É - —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –±–µ–∑ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π
    personnel_query = """
    SELECT DISTINCT e.employee_number
    FROM personnel_v2.employee e 
    LEFT JOIN personnel_v2.title_dep_summary tds ON tds.employee_number = e.employee_number
    LEFT JOIN personnel_v2.flight_info fi ON fi.employee_number = e.employee_number 
    LEFT JOIN personnel_v2.personnel_object_link pol ON pol.type = 'A008' 
        AND pol.expired = FALSE 
        AND pol.obj_id2 = LPAD(e.employee_number::text, 8, '0')
    WHERE e.type IN (1, 2)
        AND e.status = 1
        AND e.employee_number < 300000
        AND (tds.id IS NULL OR (tds.title_id != fi.position AND fi.position != '99999999') 
             OR tds.title_id != pol.obj_id1)
    ORDER BY e.employee_number
    """
    
    cursor.execute(personnel_query)
    personnel_employees = [row[0] for row in cursor.fetchall()]
    
    print(f"‚úì –ü–æ–ª—É—á–µ–Ω–æ {len(personnel_employees)} —Ç–∞–±–µ–ª—å–Ω–∏–∫–æ–≤ –∏–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞")
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
    all_employees = set(accord_employees) | set(personnel_employees)
    
    cursor.close()
    
    print(f"‚úì –í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–∞–±–µ–ª—å–Ω–∏–∫–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {len(all_employees)}")
    
    return sorted(list(all_employees))


def validate_sql_script(cursor, sql_scripts):
    """
    –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ SQL-—Å–∫—Ä–∏–ø—Ç—ã.
    
    Args:
        cursor: –∫—É—Ä—Å–æ—Ä –ë–î
        sql_scripts: —Å–ø–∏—Å–æ–∫ SQL-—Å–∫—Ä–∏–ø—Ç–æ–≤
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    """
    validation_results = {
        'total_scripts': len(sql_scripts),
        'valid_scripts': 0,
        'invalid_scripts': 0,
        'errors': [],
        'warnings': []
    }
    
    for i, sql in enumerate(sql_scripts):
        if not sql or not sql.strip():
            validation_results['warnings'].append(f"–ü—É—Å—Ç–æ–π —Å–∫—Ä–∏–ø—Ç #{i}")
            continue
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
        sql = sql.strip()
        if not sql.endswith(';'):
            validation_results['warnings'].append(f"–°–∫—Ä–∏–ø—Ç #{i} –Ω–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ ';'")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
        required_tables = ['personnel_v2.employee', 'personnel_v2.flight_info', 
                         'personnel_v2.title_dep_summary', 'personnel_v2.personnel_object_link']
        
        valid_table = False
        for table in required_tables:
            if table in sql:
                valid_table = True
                break
        
        if not valid_table:
            validation_results['errors'].append(f"–°–∫—Ä–∏–ø—Ç #{i}: –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —Ü–µ–ª–µ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞")
            continue
        
        validation_results['valid_scripts'] += 1
    
    validation_results['invalid_scripts'] = (
        validation_results['total_scripts'] - validation_results['valid_scripts']
    )
    
    return validation_results


def check_data_consistency(cursor, employee_numbers):
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º.
    
    Args:
        cursor: –∫—É—Ä—Å–æ—Ä –ë–î
        employee_numbers: —Å–ø–∏—Å–æ–∫ —Ç–∞–±–µ–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
    """
    if not employee_numbers:
        return {'status': 'empty', 'message': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏'}
    
    results = {
        'checked_count': len(employee_numbers),
        'issues': [],
        'summary': {}
    }
    
    try:
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
        check_query = """
        SELECT 
            COUNT(DISTINCT e.employee_number) as total_employees,
            COUNT(DISTINCT tds.employee_number) as with_title_dep,
            COUNT(DISTINCT fi.employee_number) as with_flight_info,
            COUNT(DISTINCT pol.employee_number) as with_position_link
        FROM UNNEST(ARRAY[%s]) ids(ids)
        LEFT JOIN personnel_v2.employee e ON e.employee_number = ids.ids
        LEFT JOIN personnel_v2.title_dep_summary tds ON tds.employee_number = e.employee_number
        LEFT JOIN personnel_v2.flight_info fi ON fi.employee_number = e.employee_number AND fi.expired = FALSE
        LEFT JOIN personnel_v2.personnel_object_link pol ON pol.type = 'A008' 
            AND pol.expired = FALSE 
            AND pol.obj_id2 = LPAD(e.employee_number::text, 8, '0')
        """ % ','.join(str(int(e)) for e in employee_numbers)
        
        cursor.execute(check_query)
        row = cursor.fetchone()
        
        results['summary'] = {
            'total_in_list': row[0],
            'in_employee_table': row[0],
            'with_title_dep_summary': row[1],
            'with_flight_info': row[2],
            'with_position_link': row[3],
            'missing_in_employee': row[0] - row[0],
            'missing_title_dep': row[0] - row[1],
            'missing_flight_info': row[0] - row[2],
            'missing_position_link': row[0] - row[3]
        }
        
        # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –≤ –¥–æ–ª–∂–Ω–æ—Å—Ç—è—Ö
        diff_query = """
        SELECT 
            COUNT(*) as discrepancies
        FROM UNNEST(ARRAY[%s]) ids(ids)
        JOIN personnel_v2.employee e ON e.employee_number = ids.ids
        JOIN personnel_v2.title_dep_summary tds ON tds.employee_number = e.employee_number
        JOIN personnel_v2.flight_info fi ON fi.employee_number = e.employee_number AND fi.expired = FALSE
        WHERE tds.title_id != fi.position AND fi.position != '99999999'
        """ % ','.join(str(int(e)) for e in employee_numbers)
        
        cursor.execute(diff_query)
        results['summary']['position_discrepancies'] = cursor.fetchone()[0]
        
        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ personnel_object_link
        pol_query = """
        SELECT 
            COUNT(*) as expired_count
        FROM personnel_v2.personnel_object_link pol
        JOIN UNNEST(ARRAY[%s]) ids(ids) ON pol.employee_number = ids.ids::int
        WHERE pol.type = 'A008' AND pol.expired = TRUE
        """ % ','.join(str(int(e)) for e in employee_numbers)
        
        cursor.execute(pol_query)
        results['summary']['expired_position_links'] = cursor.fetchone()[0]
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        if results['summary']['missing_in_employee'] > 0:
            results['issues'].append(
                f"‚ö† {results['summary']['missing_in_employee']} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ employee - "
                "–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–∑ –ê–∫–∫–æ—Ä–¥–∞"
            )
        
        if results['summary']['position_discrepancies'] > 0:
            results['issues'].append(
                f"‚ö† {results['summary']['position_discrepancies']} —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –≤ –¥–æ–ª–∂–Ω–æ—Å—Ç—è—Ö –º–µ–∂–¥—É "
                "title_dep_summary –∏ flight_info"
            )
        
        if results['summary']['expired_position_link'] > 0:
            results['issues'].append(
                f"‚ö† {results['summary']['expired_position_links']} –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ "
                "personnel_object_link"
            )
        
        if not results['issues']:
            results['issues'].append("‚úì –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ")
        
        results['status'] = 'completed'
        
    except Exception as e:
        results['status'] = 'error'
        results['error'] = str(e)
    
    return results


def check_update_result(cursor, employee_numbers):
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
    
    Args:
        cursor: –∫—É—Ä—Å–æ—Ä –ë–î
        employee_numbers: —Å–ø–∏—Å–æ–∫ —Ç–∞–±–µ–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
    """
    if not employee_numbers:
        return {'status': 'empty', 'message': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏'}
    
    results = {
        'employee_number': 0,
        'title_updated': 0,
        'flight_info_updated': 0,
        'position_link_updated': 0,
        'title_dep_summary_updated': 0
    }
    
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è employee
        emp_query = """
        SELECT COUNT(*) 
        FROM personnel_v2.employee e
        JOIN UNNEST(ARRAY[%s]) ids(ids) ON e.employee_number = ids.ids
        WHERE e.update_date >= NOW() - INTERVAL '1 hour'
        """ % ','.join(str(int(e)) for e in employee_numbers)
        
        cursor.execute(emp_query)
        results['employee_updated'] = cursor.fetchone()[0]
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è title_dep_summary
        tds_query = """
        SELECT COUNT(*) 
        FROM personnel_v2.title_dep_summary tds
        JOIN UNNEST(ARRAY[%s]) ids(ids) ON tds.employee_number = ids.ids
        WHERE tds.update_date >= NOW() - INTERVAL '1 hour'
        """ % ','.join(str(int(e)) for e in employee_numbers)
        
        cursor.execute(tds_query)
        results['title_dep_summary_updated'] = cursor.fetchone()[0]
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è flight_info
        fi_query = """
        SELECT COUNT(*) 
        FROM personnel_v2.flight_info fi
        JOIN UNNEST(ARRAY[%s]) ids(ids) ON fi.employee_number = ids.ids
        WHERE fi.update_date >= NOW() - INTERVAL '1 hour'
        """ % ','.join(str(int(e)) for e in employee_numbers)
        
        cursor.execute(fi_query)
        results['flight_info_updated'] = cursor.fetchone()[0]
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è personnel_object_link
        pol_query = """
        SELECT COUNT(*) 
        FROM personnel_v2.personnel_object_link pol
        JOIN UNNEST(ARRAY[%s]) ids(ids) ON pol.employee_number = ids.ids::int
        WHERE pol.type = 'A008' AND pol.update_date >= NOW() - INTERVAL '1 hour'
        """ % ','.join(str(int(e)) for e in employee_numbers)
        
        cursor.execute(pol_query)
        results['position_link_updated'] = cursor.fetchone()[0]
        
        results['status'] = 'completed'
        
    except Exception as e:
        results['status'] = 'error'
        results['error'] = str(e)
    
    return results


def generate_validation_report(cursor, employee_numbers):
    """
    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç –æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö.
    
    Args:
        cursor: –∫—É—Ä—Å–æ—Ä –ë–î
        employee_numbers: —Å–ø–∏—Å–æ–∫ —Ç–∞–±–µ–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
    
    Returns:
        –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç
    """
    report_lines = []
    report_lines.append("=" * 70)
    report_lines.append("–û–¢–ß–Å–¢ –û –í–ê–õ–ò–î–ê–¶–ò–ò –î–ê–ù–ù–´–•")
    report_lines.append(f"–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    report_lines.append(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: {len(employee_numbers)}")
    report_lines.append("=" * 70)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
    consistency = check_data_consistency(cursor, employee_numbers)
    
    report_lines.append("\nüìã –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–†–û–í–ï–†–ö–ò –ö–û–ù–°–ò–°–¢–ï–ù–¢–ù–û–°–¢–ò:")
    report_lines.append("-" * 70)
    
    if consistency.get('summary'):
        summary = consistency['summary']
        report_lines.append(f"  –í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ —Å–ø–∏—Å–∫–µ:        {summary['total_in_list']}")
        report_lines.append(f"  –í —Ç–∞–±–ª–∏—Ü–µ employee:                {summary['in_employee_table']}")
        report_lines.append(f"  –° title_dep_summary:              {summary['with_title_dep_summary']}")
        report_lines.append(f"  –° flight_info:                    {summary['with_flight_info']}")
        report_lines.append(f"  –° personnel_object_link:          {summary['with_position_link']}")
        report_lines.append("")
        report_lines.append(f"  ‚ö† –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –≤ –¥–æ–ª–∂–Ω–æ—Å—Ç—è—Ö:       {summary.get('position_discrepancies', 0)}")
        report_lines.append(f"  ‚ö† –ù–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫:            {summary.get('expired_position_link', 0)}")
    
    if consistency.get('issues'):
        report_lines.append("\n‚ö† –í–´–Ø–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:")
        for issue in consistency['issues']:
            report_lines.append(f"  {issue}")
    
    # –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∞–Ω–∞–ª–æ–≥ –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ app.txt)
    report_lines.append("\nüìä –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –î–ê–ù–ù–´–•:")
    report_lines.append("-" * 70)
    
    try:
        detail_query = """
        SELECT 
            en,
            e.surname || ' ' || e.name || ' ' || COALESCE(e.patronymic, '') AS fio,
            e.type AS emp_type,
            e.status AS emp_status,
            tds.title,
            tds.title_id,
            fi.position AS fi_position,
            pol.obj_id1 AS pol_position,
            pol.expired AS pol_expired,
            fi.base_airport
        FROM UNNEST(ARRAY[%s]) AS en
        LEFT JOIN personnel_v2.employee e ON e.employee_number = en
        LEFT JOIN personnel_v2.flight_info fi ON fi.employee_number = en AND fi.expired = FALSE
        LEFT JOIN personnel_v2.title_dep_summary tds ON tds.employee_number = e.employee_number
        LEFT JOIN personnel_v2.personnel_object_link pol ON pol.type = 'A008' 
            AND pol.expired = FALSE 
            AND pol.obj_id2 = LPAD(e.employee_number::text, 8, '0')
        ORDER BY en
        """ % ','.join(str(int(e)) for e in employee_numbers[:100])  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º first 100 –¥–ª—è –æ—Ç—á—ë—Ç–∞
        
        cursor.execute(detail_query)
        rows = cursor.fetchall()
        
        report_lines.append(f"\n  –ü–æ–∫–∞–∑–∞–Ω–æ –ø–µ—Ä–≤—ã—Ö {len(rows)} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ {len(employee_numbers)}:")
        
        for row in rows[:10]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º first 10
            en, fio, emp_type, emp_status, title, title_id, fi_position, pol_position, pol_expired, base_airport = row
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
            is_actual = (title_id == pol_position) if (pol_position and title_id) else False
            
            status_icon = "‚úì" if is_actual else "‚úó"
            report_lines.append(f"  {status_icon} [{en}] {fio}")
            report_lines.append(f"      –î–æ–ª–∂–Ω–æ—Å—Ç—å: {title or '–ù–ï–¢'} (ID: {title_id})")
            report_lines.append(f"      POL: {pol_position or '–ù–ï–¢'} | FI: {fi_position or '–ù–ï–¢'}")
            report_lines.append(f"      –ë–∞–∑–∞: {base_airport or '–ù–ï–¢'}")
        
        if len(rows) > 10:
            report_lines.append(f"  ... –∏ –µ—â—ë {len(rows) - 10} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤")
        
    except Exception as e:
        report_lines.append(f"  ‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é: {e}")
    
    report_lines.append("\n" + "=" * 70)
    report_lines.append("–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:")
    report_lines.append("-" * 70)
    
    if consistency.get('summary', {}).get('missing_in_employee', 0) > 0:
        report_lines.append("  1. –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ –ê–∫–∫–æ—Ä–¥–∞ –≤ —Ç–∞–±–ª–∏—Ü—É employee")
    
    if consistency.get('summary', {}).get('position_discrepancies', 0) > 0:
        report_lines.append("  2. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –≤ title_dep_summary —Å–æ–≥–ª–∞—Å–Ω–æ flight_info")
    
    if consistency.get('summary', {}).get('expired_position_link', 0) > 0:
        report_lines.append("  3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ personnel_object_link")
    
    if not consistency.get('issues') or all("‚úì" in i for i in consistency.get('issues', [])):
        report_lines.append("  ‚úì –î–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é")
    
    report_lines.append("=" * 70)
    
    return '\n'.join(report_lines)


def generate_employee_updates(cursor, employee_numbers):
    """
    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å UPDATE-—Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã employee.
    
    Args:
        cursor: –∫—É—Ä—Å–æ—Ä –ë–î ms-personnel
        employee_numbers: —Å–ø–∏—Å–æ–∫ —Ç–∞–±–µ–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
    
    Returns:
        –°–ø–∏—Å–æ–∫ SQL-—Å–∫—Ä–∏–ø—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    """
    if not employee_numbers:
        return []
    
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ adp-sap –¥–ª—è dblink
    adp_sap_host = get_env_or_default('ADP_SAP_HOST', '192.168.1.62')
    adp_sap_port = get_env_or_default('ADP_SAP_PORT', '5432')
    adp_sap_db = get_env_or_default('ADP_SAP_DB', 'adp-sap')
    adp_sap_user = get_env_or_default('ADP_SAP_USER', 'postgres')
    adp_sap_password = get_env_or_default('ADP_SAP_PASSWORD', 'password')
    
    dblink_conn = f'dbname={adp_sap_db} host={adp_sap_host} port={adp_sap_port} user={adp_sap_user} password={adp_sap_password}'
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º dblink
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º $ –¥–ª—è PostgreSQL dollar-quoting –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏ Python
    dblink_inner_query = """
SELECT pernr, vorna, nach2, nachn, inits, gesch, gbdat, natio, FAMST, famdt, creationtime
FROM parced_hrmd_lines_2
WHERE p_code = 'P0002'
AND endda = '99991231'
"""
    
    query = f"""
    SELECT * FROM (
    SELECT ids,
        ROW_NUMBER() OVER (PARTITION BY ids ORDER BY phl.creationtime DESC) id_rn,
        'UPDATE personnel_v2.employee SET ' ||
            '"name"=' || COALESCE('''' || phl.vorna || '''', 'NULL') || ', ' ||
            'patronymic=' || COALESCE('''' || phl.nach2 || '''', 'NULL') || ', ' ||
            '"surname"=' || COALESCE('''' || phl.nachn || '''', 'NULL') || ', ' ||
            'initials=' || COALESCE('''' || phl.inits || '''', 'NULL') || ', ' ||
            'sex=' || CASE WHEN phl.gesch = '2' THEN '''F''' ELSE '''M''' END || ', ' ||
            'birth_date=' || COALESCE('''' || TO_CHAR(TO_DATE(phl.gbdat, 'YYYYMMDD'), 'YYYY-MM-DD') || '''', 'NULL') || ', ' ||
            'citizenship=' || COALESCE('''' || phl.natio || '''', 'NULL') || ', ' ||
            'marital_status=' || COALESCE(phl.FAMST::text, '1') || ', ' ||
            'marital_status_date=' || COALESCE('''' || TO_CHAR(TO_DATE(phl.famdt, 'YYYYMMDD'), 'YYYY-MM-DD') || '''', 'NULL') || ', ' ||
            'update_user=''SYSTEM'', update_date=NOW(), status=1, expired=FALSE ' ||
            'WHERE employee_number=' || phl.pernr || ';' AS sql_update,
        phl.pernr
    FROM UNNEST(ARRAY[{','.join(str(int(e)) for e in employee_numbers)}]) ids
    LEFT JOIN personnel_v2.dblink(
        '{dblink_conn}'::text,
        $dblink_inner_query$
    ) AS phl(pernr TEXT, vorna TEXT, nach2 TEXT, nachn TEXT, inits TEXT, gesch TEXT, gbdat TEXT, natio TEXT, FAMST TEXT, famdt TEXT, creationtime TIMESTAMP)
        ON phl.pernr = LPAD(ids::text, 8, '0')
    ) sorted
    WHERE sorted.id_rn = 1
    AND sorted.pernr IS NOT NULL
    ORDER BY sorted.pernr::int
    """
    # –ó–∞–º–µ–Ω—è–µ–º placeholder –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å $ –¥–ª—è PostgreSQL
    query = query.replace('$dblink_inner_query$', dblink_inner_query.strip())
    
    try:
        cursor.execute(query)
        results = cursor.fetchall()
        
        scripts = []
        for row in results:
            if row[1]:  # sql_update
                scripts.append(row[1])
        
        return scripts
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π employee: {e}")
        return []


def generate_flight_info_updates(cursor, employee_numbers):
    """
    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å UPDATE-—Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã flight_info.
    
    Args:
        cursor: –∫—É—Ä—Å–æ—Ä –ë–î ms-personnel
        employee_numbers: —Å–ø–∏—Å–æ–∫ —Ç–∞–±–µ–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
    
    Returns:
        –°–ø–∏—Å–æ–∫ SQL-—Å–∫—Ä–∏–ø—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    """
    if not employee_numbers:
        return []
    
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ adp-sap –¥–ª—è dblink
    adp_sap_host = get_env_or_default('ADP_SAP_HOST', '192.168.1.62')
    adp_sap_port = get_env_or_default('ADP_SAP_PORT', '5432')
    adp_sap_db = get_env_or_default('ADP_SAP_DB', 'adp-sap')
    adp_sap_user = get_env_or_default('ADP_SAP_USER', 'postgres')
    adp_sap_password = get_env_or_default('ADP_SAP_PASSWORD', 'password')
    
    dblink_conn = f'dbname={adp_sap_db} host={adp_sap_host} port={adp_sap_port} user={adp_sap_user} password={adp_sap_password}'
    
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ms-personnel –¥–ª—è dblink (—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏)
    ms_personnel_host = get_env_or_default('DB_HOST', '192.168.1.62')
    ms_personnel_port = get_env_or_default('DB_PORT', '5432')
    ms_personnel_user = get_env_or_default('DB_USER', 'postgres')
    ms_personnel_password = get_env_or_default('DB_PASSWORD', 'password')
    
    ms_personnel_dblink = f'dbname=ms-personnel host={ms_personnel_host} port={ms_personnel_port} user={ms_personnel_user} password={ms_personnel_password}'
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º dblink
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º $ –¥–ª—è PostgreSQL dollar-quoting –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏ Python
    dblink_sap_inner_query = """
SELECT pernr, persk, plans, werks, creationtime
FROM parced_hrmd_lines_2
WHERE p_code = 'P0001'
AND endda = '99991231'
AND raw_message_id NOT LIKE 'P%%'
"""
    
    dblink_section_inner_query = """
SELECT id AS st_id, code FROM personnel_v2.section_type
"""
    
    dblink_airport_inner_query = """
SELECT id AS sa_id FROM personnel_v2.section_airport
"""
    
    query = f"""
    SELECT * FROM (
    SELECT ids,
        phl.pernr,
        ROW_NUMBER() OVER (PARTITION BY ids ORDER BY phl.creationtime DESC) id_rn,
        'UPDATE personnel_v2.flight_info SET ' ||
            'category=' || COALESCE(phl.persk::text, 'NULL') || ', ' ||
            '"section"=' || COALESCE(st.st_id::text, 'NULL') || ', ' ||
            'base_airport=' || COALESCE(sa.sa_id::text, 'NULL') || ', ' ||
            '"position"=' || COALESCE('''' || phl.plans || '''', 'NULL') || ', ' ||
            'expired=FALSE, update_user=''SYSTEM'', update_date=NOW() ' ||
            'WHERE employee_number=' || ids::text || ';' AS sql_update
    FROM UNNEST(ARRAY[{','.join(str(int(e)) for e in employee_numbers)}]) ids
    LEFT JOIN personnel_v2.dblink(
        '{dblink_conn}'::text,
        $dblink_sap_inner_query$
    ) AS phl(pernr TEXT, persk TEXT, plans TEXT, werks TEXT, creationtime TIMESTAMP)
        ON phl.pernr = LPAD(ids::text, 8, '0')
    LEFT JOIN personnel_v2.dblink(
        '{ms_personnel_dblink}'::text,
        $dblink_section_inner_query$
    ) AS st(st_id INT, code TEXT) ON st.code = phl.werks
    LEFT JOIN personnel_v2.dblink(
        '{ms_personnel_dblink}'::text,
        $dblink_airport_inner_query$
    ) AS sa(sa_id INT) ON LPAD(sa.sa_id::text, 4, '0') = phl.werks
    ) sorted
    WHERE sorted.id_rn = 1
    AND sorted.pernr IS NOT NULL
    ORDER BY ids
    """
    # –ó–∞–º–µ–Ω—è–µ–º placeholders –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å $ –¥–ª—è PostgreSQL
    query = query.replace('$dblink_sap_inner_query$', dblink_sap_inner_query.strip())
    query = query.replace('$dblink_section_inner_query$', dblink_section_inner_query.strip())
    query = query.replace('$dblink_airport_inner_query$', dblink_airport_inner_query.strip())
    
    try:
        cursor.execute(query)
        results = cursor.fetchall()
        
        scripts = []
        for row in results:
            if row[1]:  # sql_update
                scripts.append(row[1])
        
        return scripts
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π flight_info: {e}")
        return []


def generate_full_script(employee_numbers, conn, validation_report=None):
    """
    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü.
    
    Args:
        employee_numbers: —Å–ø–∏—Å–æ–∫ —Ç–∞–±–µ–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
        conn: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
        validation_report: –æ—Ç—á—ë—Ç –æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    
    Returns:
        –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç SQL-—Å–∫—Ä–∏–ø—Ç–∞
    """
    cursor = conn.cursor(cursor_factory=RealDictCursor)
    
    script_parts = []
    script_parts.append("-- ========================================")
    script_parts.append(f"-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –°–ê–ü")
    script_parts.append(f"-- –î–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    script_parts.append(f"-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {len(employee_numbers)}")
    script_parts.append("-- ========================================")
    script_parts.append("")
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—á—ë—Ç –æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
    if validation_report:
        script_parts.append("-- " + "=" * 66)
        script_parts.append("-- –û–¢–ß–Å–¢ –û –í–ê–õ–ò–î–ê–¶–ò–ò (–ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó)")
        script_parts.append("-- " + "=" * 66)
        for line in validation_report.split('\n'):
            script_parts.append(f"-- {line}")
        script_parts.append("")
    
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ employee
    script_parts.append("-- ========================================")
    script_parts.append("-- –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ employee (–§–ò–û, –≤–æ–∑—Ä–∞—Å—Ç, –≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ)")
    script_parts.append("-- ========================================")
    script_parts.append("")
    
    employee_scripts = generate_employee_updates(cursor, employee_numbers)
    for sql in employee_scripts:
        script_parts.append(sql)
    
    script_parts.append("")
    
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ flight_info
    script_parts.append("-- ========================================")
    script_parts.append("-- –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ flight_info (–±–∞–∑–æ–≤—ã–π –∞—ç—Ä–æ–ø–æ—Ä—Ç, –¥–æ–ª–∂–Ω–æ—Å—Ç—å)")
    script_parts.append("-- ========================================")
    script_parts.append("")
    
    flight_scripts = generate_flight_info_updates(cursor, employee_numbers)
    for sql in flight_scripts:
        script_parts.append(sql)
    
    script_parts.append("")
    script_parts.append("-- ========================================")
    script_parts.append("-- –ö–û–ù–ï–¶ –°–ö–†–ò–ü–¢–ê")
    script_parts.append("-- ========================================")
    
    cursor.close()
    
    return '\n'.join(script_parts)


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è."""
    parser = argparse.ArgumentParser(
        description='–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–æ–ª–∂–Ω–æ—Å—Ç—è–º –∏–∑ –°–ê–ü'
    )
    parser.add_argument(
        '--output', '-o',
        default='update_script.sql',
        help='–ü—É—Ç—å –∫ –≤—ã—Ö–æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: update_script.sql)'
    )
    parser.add_argument(
        '--days', '-d',
        type=int,
        default=50,
        help='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –≤—ã–±–æ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ –ê–∫–∫–æ—Ä–¥–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 50)'
    )
    parser.add_argument(
        '--validate-only', '-v',
        action='store_true',
        help='–¢–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞'
    )
    parser.add_argument(
        '--preview', '-p',
        action='store_true',
        help='–¢–æ–ª—å–∫–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (–±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª)'
    )
    parser.add_argument(
        '--test', '-t',
        action='store_true',
        help='–í—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö'
    )
    parser.add_argument(
        '--test-output',
        default='test_report.txt',
        help='–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –æ—Ç—á—ë—Ç–∞ –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: test_report.txt)'
    )
    
    args = parser.parse_args()
    
    print("=" * 60)
    print("–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–æ–ª–∂–Ω–æ—Å—Ç—è–º –∏–∑ –°–ê–ü")
    print("=" * 60)
    
    try:
        # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
        conn = get_db_connection('personnel')
        conn.autocommit = True  # –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
        print("‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å–ø–µ—à–Ω–æ")
        
        # –°–±–æ—Ä —Ç–∞–±–µ–ª—å–Ω–∏–∫–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        print("\n[1/5] –°–±–æ—Ä —Ç–∞–±–µ–ª—å–Ω–∏–∫–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...")
        employee_numbers = collect_employee_numbers_for_update(conn)
        print(f"‚úì –ù–∞–π–¥–µ–Ω–æ {len(employee_numbers)} —Ç–∞–±–µ–ª—å–Ω–∏–∫–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
        
        if not employee_numbers:
            print("‚ö† –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
            conn.close()
            return
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        print("\n[2/5] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö...")
        try:
            val_cursor = conn.cursor()
            validation_report = generate_validation_report(val_cursor, employee_numbers)
            val_cursor.close()
        except Exception as e:
            print(f"‚ö† –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: {e}")
            conn.rollback()
            validation_report = None
        print(validation_report or "–í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏")
        
        # –¢–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–∞—Ü–∏—è
        if args.validate_only:
            print("\n[3/5] –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
            conn.close()
            return
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–∞
        print("\n[4/5] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...")
        full_script = generate_full_script(employee_numbers, conn, validation_report)
        print(f"‚úì –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(full_script)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        # –†–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        if args.test:
            print(f"\n[5/5] –†–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑–µ...")
            
            try:
                # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
                test_conn = get_db_connection('test')
                print("‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î —É—Å–ø–µ—à–Ω–æ")
                
                # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
                test_results = run_test_cycle(employee_numbers, full_script, test_conn)
                
                # –í—ã–≤–æ–¥ –æ—Ç—á—ë—Ç–∞
                print("\n" + test_results['report'])
                
                # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–∞
                with open(args.test_output, 'w', encoding='utf-8') as f:
                    f.write(test_results['report'])
                print(f"\n‚úì –û—Ç—á—ë—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Ñ–∞–π–ª {args.test_output}")
                
                test_conn.close()
                
            except psycopg2.Error as e:
                print(f"‚ö† –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î: {e}")
                print("‚ö† –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ TEST_DB_* –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ .env")
        
        # –í—ã–≤–æ–¥ –∏–ª–∏ –∑–∞–ø–∏—Å—å
        if args.preview:
            print("\n[5/5] –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–∫—Ä–∏–ø—Ç–∞ (–ø–µ—Ä–≤—ã–µ 100 —Å—Ç—Ä–æ–∫):")
            print("-" * 60)
            lines = full_script.split('\n')
            for line in lines[:100]:
                print(line)
            if len(lines) > 100:
                print(f"... –∏ –µ—â—ë {len(lines) - 100} —Å—Ç—Ä–æ–∫")
        else:
            print(f"\n[5/5] –ó–∞–ø–∏—Å—å —Å–∫—Ä–∏–ø—Ç–∞ –≤ —Ñ–∞–π–ª {args.output}...")
            with open(args.output, 'w', encoding='utf-8') as f:
                f.write(full_script)
            print(f"‚úì –°–∫—Ä–∏–ø—Ç –∑–∞–ø–∏—Å–∞–Ω –≤ —Ñ–∞–π–ª {args.output}")
        
        print("\n" + "=" * 60)
        print("–ì–û–¢–û–í–û! –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:")
        print("=" * 60)
        print("1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç")
        if not args.test:
            print("2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: python sap_position_updater.py --test")
        print("3. –°–¥–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–π –ë–î")
        print("4. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–π –ë–î")
        print("=" * 60)
        
        conn.close()
        
    except psycopg2.Error as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        sys.exit(1)


if __name__ == '__main__':
    main()

